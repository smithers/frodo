{% extends 'base.html' %}

{% block title %}Add a Book You Love{% endblock %}

{% block extra_head %}
<style>
    h1 {
        border-bottom: 4px solid #8b0000;
        padding-bottom: 15px;
        margin-bottom: 30px;
        display: inline-block;
    }
    
    /* Make the autocomplete dropdown look nice */
    .ui-autocomplete { 
        background-color: #ffffff; 
        border: 2px solid #1a1a1a; 
        z-index: 1000; 
        max-height: 250px; 
        overflow-y: auto; 
        cursor: pointer; 
        list-style: none;
        padding-left: 0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: 0;
    }
    .ui-menu-item {
        padding: 12px 15px;
        border-bottom: 1px solid #1a1a1a;
        transition: background-color 0.2s ease;
    }
    .ui-menu-item:hover {
        background-color: #ffffff;
        border-left: 3px solid #8b0000;
    }
    
    .selected-books {
        margin-top: 30px;
    }
    
    .book-item {
        background: #ffffff;
        border: 2px solid #1a1a1a;
        padding: 3px 25px;
        margin-bottom: 20px;
        border-radius: 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: box-shadow 0.3s ease;
    }
    
    .book-item:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        border-color: #8b0000;
    }
    
    .book-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 0 0 15px 0;
        border-bottom: 2px solid #1a1a1a;
    }
    
    .book-info h4 {
        margin: 0 0 8px 0;
        color: #1a1a1a;
        font-family: 'Playfair Display', serif;
        font-size: 1.3em;
    }
    
    .book-info p {
        margin: 0;
        color: #1a1a1a;
        font-size: 1em;
        font-style: italic;
    }
    
    .explanation-input {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #1a1a1a;
        border-radius: 0;
        font-size: 1em;
        font-family: 'Lora', serif;
        margin-top: 15px;
        background: #ffffff;
        color: #1a1a1a;
        line-height: 1.8;
        transition: border-color 0.3s ease;
    }
    
    .explanation-input:focus {
        outline: none;
        border-color: #8b0000;
        border-width: 2px;
    }
    
    .explanation-label {
        font-size: 0.9em;
        color: #1a1a1a;
        margin-top: 8px;
        font-weight: 400;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .remove-btn {
        background: transparent;
        color: #8b0000;
        border: 2px solid #8b0000;
        padding: 8px 18px;
        border-radius: 0;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 400;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        font-family: 'Lora', serif;
    }
    
    .remove-btn:hover {
        background: #8b0000;
        color: #ffffff;
    }
    
    #book-search {
        border: 2px solid #1a1a1a;
        border-radius: 0;
        padding: 12px 15px;
        font-family: 'Lora', serif;
        font-size: 1em;
        background: #ffffff;
        color: #1a1a1a;
        transition: border-color 0.3s ease;
    }
    
    #book-search:focus {
        outline: none;
        border-color: #8b0000;
        border-width: 2px;
    }
    
    button[type="submit"] {
        background-color: #1a1a1a;
        color: #ffffff;
        border: 2px solid #1a1a1a;
        padding: 15px 30px;
        font-size: 1em;
        font-weight: 400;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        border-radius: 0;
        transition: all 0.3s ease;
        font-family: 'Lora', serif;
    }
    
    button[type="submit"]:hover {
        background-color: #8b0000;
        border-color: #8b0000;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    @media (max-width: 1024px) {
        #book-search {
            width: 100% !important;
            max-width: 100% !important;
        }
        
        .book-item {
            padding: 20px;
        }
        
        .book-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
        
        .remove-btn {
            width: 100%;
        }
        
        button[type="submit"] {
            width: 100%;
        }
        
        h1 {
            font-size: 1.8em;
        }
    }
</style>
{% endblock %}

{% block content %}
    <h1>Add Books You Love</h1>
    <p style="font-size: 1.1em; color: #1a1a1a; font-style: italic; margin-bottom: 30px;">Search for books to add them to your favorites.</p>
    
    <div style="margin-bottom: 30px; position: relative;">
        <label style="font-weight: 400; color: #1a1a1a; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.9em; display: block; margin-bottom: 10px;"><strong>Search by Title:</strong></label>
        <input type="text" id="book-search" placeholder="Enter a book you love (type slowly)" style="width: 100%; max-width: 500px;">
        <span id="loading-msg" style="display:none; color: #8b0000; margin-left: 15px; font-style: italic;"> Searching Google...</span>
    </div>

    <form method="POST" action="{% url 'save_favorite' %}" id="favorites-form">
        {% csrf_token %}
        <div id="selected-books-container" class="selected-books" style="display: none;">
            <h3 style="color: #1a1a1a; border-bottom: 3px solid #8b0000; padding-bottom: 15px; margin-bottom: 25px; display: inline-block;">Selected Books:</h3>
            <div id="selected-books-list"></div>
            <button type="submit" style="margin-top: 25px;">
                Add to My Favorites
            </button>
        </div>
    </form>
{% endblock %}

{% block scripts %}
<script>
$(function() {
    var selectedBooks = [];
    
    $("#book-search").autocomplete({
        source: "{% url 'book_autocomplete' %}", 
        minLength: 3, 
        delay: 300,   
        
        search: function() {
            $("#loading-msg").show();
        },
        
        response: function() {
            $("#loading-msg").hide();
        },

        select: function(event, ui) {
            event.preventDefault();
            var book = ui.item;
            
            // Check if book is already selected
            if (selectedBooks.find(b => b.isbn === book.isbn)) {
                return;
            }
            
            // Add to selected books
            selectedBooks.push({
                title: book.value,
                author: book.author,
                isbn: book.isbn,
                explanation: ''
            });
            
            // Clear search box
            $("#book-search").val('');
            
            // Update display
            updateSelectedBooksList();
        }
    });
    
    function updateSelectedBooksList() {
        var container = $("#selected-books-list");
        container.empty();
        
        selectedBooks.forEach(function(book, index) {
            var item = $('<div class="book-item"></div>');
            item.html(
                '<div class="book-header">' +
                    '<div class="book-info">' +
                        '<h4 style="display: inline; margin: 0; margin-right: 8px;">' + book.title + '</h4>' +
                        '<p style="display: inline; margin: 0;">by ' + book.author + '</p>' +
                    '</div>' +
                    '<button type="button" class="remove-btn" data-index="' + index + '">Remove</button>' +
                '</div>' +
                '<label class="explanation-label">Why do you love this book? (optional)</label>' +
                '<textarea class="explanation-input" placeholder="Enter a short explanation..." data-index="' + index + '" rows="2">' + (book.explanation || '') + '</textarea>'
            );
            container.append(item);
        });
        
        // Update hidden inputs for form submission
        updateHiddenInputs();
        
        if (selectedBooks.length > 0) {
            $("#selected-books-container").show();
        } else {
            $("#selected-books-container").hide();
        }
    }
    
    $(document).on('click', '.remove-btn', function() {
        var index = $(this).data('index');
        selectedBooks.splice(index, 1);
        updateSelectedBooksList();
    });
    
    // Update explanation when user types in the textarea
    $(document).on('input', '.explanation-input', function() {
        var index = $(this).data('index');
        selectedBooks[index].explanation = $(this).val();
        // Update only the corresponding hidden input, don't recreate everything
        var hiddenInput = $('input[name="explanation"]').eq(index);
        if (hiddenInput.length) {
            hiddenInput.val(selectedBooks[index].explanation);
        } else {
            // If hidden input doesn't exist yet, update all hidden inputs
            updateHiddenInputs();
        }
    });
    
    function updateHiddenInputs() {
        // Remove old hidden inputs
        $('input[name^="title"]').remove();
        $('input[name^="author"]').remove();
        $('input[name^="isbn"]').remove();
        $('input[name^="explanation"]').remove();
        
        // Add new hidden inputs
        selectedBooks.forEach(function(book) {
            $('#favorites-form').append(
                '<input type="hidden" name="title" value="' + $('<div>').text(book.title).html() + '">' +
                '<input type="hidden" name="author" value="' + $('<div>').text(book.author).html() + '">' +
                '<input type="hidden" name="isbn" value="' + $('<div>').text(book.isbn || '').html() + '">' +
                '<input type="hidden" name="explanation" value="' + $('<div>').text(book.explanation || '').html() + '">'
            );
        });
    }
});
</script>
{% endblock %}


